-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v2.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

-- ✅ Global Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

local clientName = "FiestaGuardVip"  -- Semua diatur oleh client ini
local jarakIkut = 5          -- Default follow distance
local jarakFormasi = 5       -- Formation distance
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false
local currentFormasiTarget = nil
local currentFormation = nil  

local botSettings = {
    ["8802945328"] = {followDistance = 5, minDistance = 2},
    ["8802949363"] = {followDistance = 5, minDistance = 2},
    ["8802939883"] = {followDistance = 5, minDistance = 2},
    ["8802998147"] = {followDistance = 5, minDistance = 2},
    ["8802991722"] = {followDistance = 5, minDistance = 2}
}

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- ✅ Reset & Stop Function
local function runStopCommand()
    followAllowed = false
    currentFormasiTarget = nil
    currentFormation = nil
    if humanoid and myRootPart then
        humanoid:MoveTo(myRootPart.Position)
    end
    Options.TextboxDisplayName:SetValue("")
    Options.TextboxFormasi1:SetValue("")
    Options.TextboxFormasi2:SetValue("")
    Options.TextboxFormasi3:SetValue("")
    Options.TextboxFormasi4:SetValue("")
    
    local args = { "leaveSync" }
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer(unpack(args))
    end)
    
    local stopArgs = { "stopAnimation", "Push Up" }
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer(unpack(stopArgs))
    end)
    
    Library:Notify("❌ Bot stopped & textboxes cleared", 3)
end

-- ✅ Restart Bot Function
local function restartBot()
    runStopCommand()
    if followConnection then followConnection:Disconnect() end
    if loopTask then loopTask:Disconnect() end
    task.wait(0.5)
    if toggleAktif then
        setupBotFollowSystem()
        Library:Notify("✅ Bot restarted with new client: "..clientName, 5)
    end
end

-- ✅ UI LEFT - Main Tab
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")

GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Enable Bot Follow",
    Default = false,
    Tooltip = "Enable to accept !ikuti commands",
    Callback = function(Value)
        toggleAktif = Value
        if Value then
            Library:Notify("Bot Follow Enabled", 3)
            if followConnection then followConnection:Disconnect() end
            if loopTask then loopTask:Disconnect() end
            setupBotFollowSystem()
        else
            Library:Notify("Bot Follow Disabled", 3)
            runStopCommand()
            if loopTask then loopTask:Disconnect() end
            if followConnection then followConnection:Disconnect() end
        end
    end,
})

GroupBox1:AddInput("NamaClientInput", {
    Default = clientName,
    Text = "Client Name",
    Placeholder = "Example: FiestaGuardVip",
    Callback = function(Value)
        clientName = Value
        print("Client set to:", clientName)
    end,
})

-- Formasi distance
GroupBox1:AddInput("JarakFormasiInput", {
    Default = "5",
    Text = "Formation Distance",
    Placeholder = "Example: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakFormasi = number
            Library:Notify("Formation distance set to: "..number, 3)
        end
    end,
})

-- ✅ Textboxes
local GroupBox3 = Tabs.Main:AddLeftGroupbox("Textbox")
GroupBox3:AddInput("TextboxDisplayName", {Default = "", Text = "Target DisplayName", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi1", {Default = "", Text = "Formation 1 Target", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi2", {Default = "", Text = "Formation 2 Target", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi3", {Default = "", Text = "Formation 3 Target", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi4", {Default = "", Text = "Formation 4 Target", Placeholder = "Empty", Callback = function(Value) end})

-- ✅ UI RIGHT - Distance Settings
local GroupBox2 = Tabs.Main:AddRightGroupbox("Distance Settings")
GroupBox2:AddInput("JarakIkutInput", {Default = "5", Text = "Follow Distance", Placeholder = "Example: 5", Callback = function(Value) local number = tonumber(Value) if number then jarakIkut = number Library:Notify("Follow distance set to: "..number, 3) end end})
GroupBox2:AddInput("JarakMinimumInput", {Default = "2", Text = "Minimum Move Distance", Placeholder = "Example: 2", Callback = function(Value) local number = tonumber(Value) if number then jarakMinimum = number Library:Notify("Minimum distance set to: "..number, 3) end end})

-- ✅ Helper Functions
local function updateBotRefs()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    myRootPart = character:WaitForChild("HumanoidRootPart")
end

local function fullRefresh()
    runStopCommand()
    task.wait(0.5)
    currentFormasiTarget = nil
    followAllowed = false
    if followConnection then followConnection:Disconnect() end
    if loopTask then loopTask:Disconnect() end
    if toggleAktif then
        setupBotFollowSystem()
    end
    Library:Notify("✅ System refreshed", 3)
end

-- Function to calculate formation position (sama seperti skrip asli)
local function getFormationPosition(targetHRP, formationType)
    local uid = tostring(localPlayer.UserId)
    local formasi = {}
    
    if formationType == "formasi1" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.RightVector * jarakFormasi),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.RightVector * -jarakFormasi),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi),
            ["8802991722"] = targetHRP.Position + Vector3.new(0, 0, -jarakFormasi)
        }
    elseif formationType == "formasi2" then
        local diagonalDist = jarakFormasi * 0.7071
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * diagonalDist) + (targetHRP.CFrame.RightVector * diagonalDist),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.LookVector * diagonalDist) + (targetHRP.CFrame.RightVector * -diagonalDist),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -diagonalDist) + (targetHRP.CFrame.RightVector * diagonalDist),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -diagonalDist) + (targetHRP.CFrame.RightVector * -diagonalDist),
            ["8802991722"] = targetHRP.Position
        }
    elseif formationType == "formasi3" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * -jarakFormasi*1.5),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * -jarakFormasi*0.5),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * jarakFormasi*0.5),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * jarakFormasi*1.5),
            ["8802991722"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi*1.2)
        }
    elseif formationType == "formasi4" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * jarakFormasi*1.5),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * jarakFormasi*0.75),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * -jarakFormasi*0.75),
            ["8802991722"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * -jarakFormasi*1.5)
        }
    end
    
    return formasi[uid]
end

-- ✅ Follow & Formation System
function setupBotFollowSystem()
    updateBotRefs()

    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player

        followConnection = player.Chatted:Connect(function(msg)
            msg = msg:lower()
            local hrp = client.Character and client.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            if msg == "!stop" then
                runStopCommand()
            elseif msg == "!refresh" then
                fullRefresh()
            elseif msg == "!gabung" then
                followAllowed = false
                Library:Notify("!gabung command received. Syncing...", 4)
                local args = { "sync", client.UserId }
                pcall(function()
                    ReplicatedStorage:WaitForChild("Connections")
                        :WaitForChild("dataProviders")
                        :WaitForChild("commandHandler")
                        :InvokeServer(unpack(args))
                end)
            elseif msg == "!ikuti" then
                followAllowed = true
                currentFormasiTarget = client
                Options.TextboxDisplayName:SetValue("")
                Library:Notify("Bot following main client: " .. client.DisplayName, 3)
            elseif msg:match("^!ikuti ") then
                runStopCommand()
                local targetDisplayName = msg:sub(8)
                local foundTarget = nil
                
                for _, p in ipairs(Players:GetPlayers()) do
                    if p.DisplayName:lower() == targetDisplayName:lower() then
                        foundTarget = p
                        break
                    end
                end
                
                if foundTarget then
                    followAllowed = true
                    currentFormasiTarget = foundTarget
                    Options.TextboxDisplayName:SetValue(foundTarget.DisplayName)
                    Library:Notify("Following: " .. foundTarget.DisplayName, 3)
                else
                    Library:Notify("❌ Target not found: " .. targetDisplayName, 3)
                end
            elseif msg == "!pushup" then
                runStopCommand()
                local args = {"playAnimation", "Push Up"}
                pcall(function()
                    ReplicatedStorage:WaitForChild("Connections")
                        :WaitForChild("dataProviders")
                        :WaitForChild("animationHandler")
                        :InvokeServer(unpack(args))
                end)
            elseif msg:match("^!formasi[1234]") then
                runStopCommand()
                local formasiCmd, displayName = msg:match("^!(formasi[1234])%s*(.*)")
                displayName = displayName and displayName:lower()
                local target = (displayName ~= "") and Players:FindFirstChild(displayName) or client
                if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                    currentFormasiTarget = target
                    local posisiTarget = getFormationPosition(target.Character.HumanoidRootPart, formasiCmd)
                    if posisiTarget then
                        currentFormation = formasiCmd
                        myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, target.Character.HumanoidRootPart.Position)
                        humanoid:MoveTo(posisiTarget)
                    end
                end
            end
        end)
    end

    for _, player in ipairs(Players:GetPlayers()) do
        setupClient(player)
    end

    Players.PlayerAdded:Connect(setupClient)
    localPlayer.CharacterAdded:Connect(updateBotRefs)

    loopTask = RunService.Heartbeat:Connect(function()
        if toggleAktif and currentFormasiTarget and currentFormasiTarget.Character and humanoid and myRootPart then
            local targetHRP = currentFormasiTarget.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local currentBotID = tostring(localPlayer.UserId)
                local settings = botSettings[currentBotID] or {followDistance = jarakIkut, minDistance = jarakMinimum}
                
                if followAllowed then
                    if currentFormation then
                        local formationPos = getFormationPosition(targetHRP, currentFormation)
                        if formationPos then
                            local dist = (myRootPart.Position - formationPos).Magnitude
                            if dist > settings.minDistance then
                                myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, targetHRP.Position)
                                humanoid:MoveTo(formationPos)
                            end
                        end
                    else
                        local followPos = targetHRP.Position - targetHRP.CFrame.LookVector * settings.followDistance
                        local dist = (myRootPart.Position - followPos).Magnitude
                        if dist > settings.minDistance then
                            myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, targetHRP.Position)
                            humanoid:MoveTo(followPos)
                        end
                    end
                end
            end
        end
    end)
end
