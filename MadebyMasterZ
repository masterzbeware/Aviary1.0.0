local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

local Window = Library:CreateWindow({
    Title = "MasterZ Toggle GUI",
    Footer = "v1.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "toggle-left"),
}

local GroupBox = Tabs.Main:AddLeftGroupbox("Toggle Section")

-- Variabel kontrol loop
local autofarmRadiology = false

-- Fungsi mencari RadiologyRoom1 yang memiliki Part berwarna biru
local function findBlueRoom()
    for _, room in pairs(workspace.RadiologyRooms:GetChildren()) do
        if room.Name == "RadiologyRoom1" and room:IsA("Model") then
            for _, part in ipairs(room:GetDescendants()) do
                if part:IsA("BasePart") and part.BrickColor == BrickColor.Blue() then
                    return room
                end
            end
        end
    end
    return nil
end

-- Fungsi utama loop autofarm
local function startRadiologyLoop()
    local TweenService = game:GetService("TweenService")
    local Players = game:GetService("Players")
    local player = Players.LocalPlayer
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")

    local function tweenTo(part)
        if not part then return end
        local tween = TweenService:Create(hrp, TweenInfo.new(1, Enum.EasingStyle.Linear), {
            CFrame = part.CFrame + Vector3.new(0, 3, 0)
        })
        tween:Play()
        tween.Completed:Wait()
    end

    while autofarmRadiology do
        local targetRoom = findBlueRoom()
        if not targetRoom then warn("Tidak ada ruangan biru ditemukan.") wait(2) continue end

        -- Step 1: ClickDetector
        local machine = targetRoom:FindFirstChild("X-Ray (with CXR and table) Machine")
        if machine then
            for _, part in ipairs(machine["X-Ray Machine"]:GetDescendants()) do
                if part:IsA("ClickDetector") then
                    for _ = 1, 3 do
                        pcall(function() fireclickdetector(part) end)
                        wait(0.5)
                    end
                    break
                end
            end
        end

        -- Step 2: Tunggu ProximityPrompt pada X-Ray Button
        local xrayBtnPrompt = targetRoom["X-Ray Button"]:FindFirstChildWhichIsA("ProximityPrompt", true)
        repeat wait() until not autofarmRadiology or (xrayBtnPrompt and xrayBtnPrompt.Enabled)
        if not autofarmRadiology then break end
        fireproximityprompt(xrayBtnPrompt)

        -- Step 3: radiologycomputer2
        local comp = targetRoom:FindFirstChild("radiologycomputer2", true)
        if comp then
            local prompt = comp:FindFirstChildWhichIsA("ProximityPrompt", true)
            if prompt then fireproximityprompt(prompt) end
        end

        -- Step 4: Attachment dengan ProximityPrompt
        for _, desc in ipairs(targetRoom:GetDescendants()) do
            if desc:IsA("Attachment") and desc:FindFirstChildWhichIsA("ProximityPrompt") then
                fireproximityprompt(desc:FindFirstChildWhichIsA("ProximityPrompt"))
                break
            end
        end

        -- Step 5: Equip Tool Wedge
        local tool = player.Backpack:FindFirstChild("Wedge")
        if tool then tool.Parent = char end

        -- Step 6: Tween ke Torso & Prox
        local torso = targetRoom:FindFirstChild("PatientRadiology", true):FindFirstChild("Torso")
        local torsoPrompt = torso and torso:FindFirstChildWhichIsA("ProximityPrompt")
        tweenTo(torso)
        if torsoPrompt then fireproximityprompt(torsoPrompt) end

        -- Step 7: Tween ke X-Ray Button & Prox
        tweenTo(xrayBtnPrompt.Parent)
        fireproximityprompt(xrayBtnPrompt)

        -- Step 8: Kembali ke Computer & Prox
        tweenTo(comp)
        fireproximityprompt(comp:FindFirstChildWhichIsA("ProximityPrompt", true))

        -- Step 9: Kembali ke Torso & Prox
        tweenTo(torso)
        if torsoPrompt then fireproximityprompt(torsoPrompt) end

        -- Step 10: Trigger Sheet di X-Ray Table
        local sheetPrompt = machine and machine["X-Ray Table"]["Table"]["Sheet"]:FindFirstChildWhichIsA("ProximityPrompt")
        if sheetPrompt then fireproximityprompt(sheetPrompt) end

        -- Step 11: Kembali ke Torso & Prox
        tweenTo(torso)
        if torsoPrompt then fireproximityprompt(torsoPrompt) end

        wait(2)
    end
end

-- Toggle GUI untuk mengaktifkan/menonaktifkan autofarm radiology
GroupBox:AddToggle("RadiologyToggle", {
    Text = "Autofarm Radiology",
    Default = false,
    Tooltip = "Otomatis menyelesaikan Radiology Room (yang biru)",
    Callback = function(state)
        autofarmRadiology = state
        if state then
            task.spawn(startRadiologyLoop)
        end
    end
})

-- Setup Theme dan Save Manager
Library.ToggleKeybind = Options.MenuKeybind
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)

SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({ "MenuKeybind" })

ThemeManager:SetFolder("MyScriptHub")
SaveManager:SetFolder("MyScriptHub/specific-game")
SaveManager:SetSubFolder("specific-place")
SaveManager:BuildConfigSection(Tabs.Main)
ThemeManager:ApplyTheme("Mocha")
