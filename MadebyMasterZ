-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v1.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

-- ✅ Global Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

local clientName = "FiestaGuardVip"
local jarakIkut = 5
local toggleAktif = false
local followAllowed = false
local currentFormasiTarget = nil
local formationMode = nil -- "follow", "shield", nil

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- ✅ Bot Mapping
local botMapping = {
    ["8802945328"] = "Bot1 - XBODYGUARDVIP01",
    ["8802949363"] = "Bot2 - XBODYGUARDVIP02",
    ["8802939883"] = "Bot3 - XBODYGUARDVIP03",
    ["8802998147"] = "Bot4 - XBODYGUARDVIP04",
}
local botIdentity = botMapping[tostring(localPlayer.UserId)] or "Unknown Bot"

-- ✅ Helper Functions
local function debugPrint(msg)
    print("[DEBUG]", msg)
end

local function updateBotRefs()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    myRootPart = character:WaitForChild("HumanoidRootPart")
    debugPrint("Bot references updated")
end

-- ✅ Reset function
local function stopFormation()
    followAllowed = false
    currentFormasiTarget = nil
    formationMode = nil
    debugPrint("Formation stopped")
    Library:Notify("Bot Formation Stopped", 3)
end

-- ✅ Shield formation
local function runShieldFormation()
    if not client or not client.Character then return end
    local targetHRP = client.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end

    -- posisi client
    local basePos = targetHRP.Position
    local lookVec = targetHRP.CFrame.LookVector

    -- posisi depan client
    local frontPos = basePos + lookVec * 5

    -- urutan bot
    local botOrder = {
        Vector3.new(-3, 0, 0), -- kiri
        Vector3.new(0, 0, 0),  -- tengah
        Vector3.new(3, 0, 0),  -- kanan
    }

    -- index bot sesuai UserId
    local myIndex = table.find({
        "8802945328", -- Bot1
        "8802949363", -- Bot2
        "8802939883", -- Bot3
        "8802998147", -- Bot4
    }, tostring(localPlayer.UserId))

    if myIndex and myIndex <= #botOrder then
        local offset = botOrder[myIndex] or Vector3.new(0,0,0)
        local finalPos = frontPos + offset

        myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, targetHRP.Position)
        humanoid:MoveTo(finalPos)
        debugPrint("Shield pos "..tostring(finalPos))
    end
end

-- ✅ Handle command
local function handleCommand(msg)
    msg = msg:lower()
    if msg:match("^!ikuti") then
        followAllowed = true
        formationMode = "follow"
        currentFormasiTarget = client
        Library:Notify("Bot following client: " .. client.DisplayName, 3)
        debugPrint("Follow started")
    elseif msg:match("^!stop") then
        stopFormation()
    elseif msg:match("^!shield") then
        followAllowed = false
        formationMode = "shield"
        currentFormasiTarget = client
        Library:Notify("Shield formation active!", 3)
        debugPrint("Shield formation started")
    end
end

-- ✅ UI - Main Tab
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")

GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Enable Bot Follow",
    Default = false,
    Tooltip = "Enable to accept commands (!ikuti, !shield, !stop)",
    Callback = function(Value)
        toggleAktif = Value
        debugPrint("ToggleAktif set to: "..tostring(Value))
        if Value then
            Library:Notify("Bot Control Enabled", 3)
            if followConnection then followConnection:Disconnect() end
            if loopTask then loopTask:Disconnect() end
            setupBotSystem()
        else
            Library:Notify("Bot Control Disabled", 3)
            stopFormation()
            if loopTask then loopTask:Disconnect() end
            if followConnection then followConnection:Disconnect() end
        end
    end,
})

GroupBox1:AddInput("JarakIkutInput", {
    Default = tostring(jarakIkut),
    Text = "Follow Distance",
    Placeholder = "Example: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakIkut = number
            debugPrint("Follow distance set to: "..number)
            Library:Notify("Follow distance set to: "..number, 3)
        end
    end,
})

GroupBox1:AddInput("BotIdentity", {
    Default = botIdentity,
    Text = "Bot Identity",
    Placeholder = "Auto-detected bot info",
    Callback = function(Value) end, -- readonly
})

-- ✅ Main System
function setupBotSystem()
    updateBotRefs()

    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player
        debugPrint("Client "..player.Name.." setup complete")

        followConnection = player.Chatted:Connect(function(msg)
            local ok, err = pcall(function()
                handleCommand(msg)
            end)
            if not ok then
                debugPrint("Error handling chat: "..err)
            end
        end)
    end

    for _, player in ipairs(Players:GetPlayers()) do
        setupClient(player)
    end

    Players.PlayerAdded:Connect(setupClient)
    localPlayer.CharacterAdded:Connect(updateBotRefs)

    loopTask = RunService.Heartbeat:Connect(function()
        if toggleAktif and currentFormasiTarget and currentFormasiTarget.Character and humanoid and myRootPart then
            local ok, err = pcall(function()
                local targetHRP = currentFormasiTarget.Character:FindFirstChild("HumanoidRootPart")
                if not targetHRP then return end

                if formationMode == "follow" and followAllowed then
                    local followPos = targetHRP.Position - targetHRP.CFrame.LookVector * jarakIkut
                    humanoid:MoveTo(followPos)

                elseif formationMode == "shield" then
                    runShieldFormation()
                end
            end)
            if not ok then
                debugPrint("Error in Heartbeat: "..err)
            end
        end
    end)
end
