-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v1.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user"),
}

-- ✅ Global Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

local clientName = ""
local jarakIkut = 5
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- ✅ Posisi Jaga (Shared)
shared.GuardedPositions = shared.GuardedPositions or {}
shared.PosisiJagaUserIDs = {
    Depan = "8802945328",
    Belakang = "8802949363",
    Kiri = "8802939883",
    Kanan = "8802998147"
}

-- ✅ UI
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")
GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Aktifkan Bot Follow",
    Default = false,
    Tooltip = "Nyalakan agar bot siap menerima perintah !ikuti",
    Callback = function(Value)
        toggleAktif = Value

        if Value then
            Library:Notify("Bot Follow Diaktifkan", 3)

            if followConnection then followConnection:Disconnect() end
            if loopTask then loopTask:Disconnect() end

            setupBotFollowSystem()
        else
            Library:Notify("Bot Follow Dimatikan", 3)
            followAllowed = false

            if loopTask then loopTask:Disconnect() end
            if followConnection then followConnection:Disconnect() end

            if humanoid and myRootPart then
                humanoid:MoveTo(myRootPart.Position)
            end
        end
    end,
})

GroupBox1:AddInput("NamaClientInput", {
    Default = "",
    Text = "Nama Client",
    Placeholder = "Contoh: MasterZ_YT",
    Callback = function(Value)
        clientName = Value
        print("Client diatur ke:", clientName)
    end,
})

local GroupBox2 = Tabs.Main:AddRightGroupbox("Pengaturan Jarak")

GroupBox2:AddInput("JarakIkutInput", {
    Default = "5",
    Text = "Jarak Bot",
    Placeholder = "Contoh: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakIkut = number
            print("Jarak bot diatur ke:", jarakIkut)
        end
    end,
})

GroupBox2:AddInput("JarakMinimumInput", {
    Default = "2",
    Text = "Jarak Minimum Bergerak",
    Placeholder = "Contoh: 2",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakMinimum = number
            print("Jarak minimum diatur ke:", jarakMinimum)
        end
    end,
})

-- ✅ Tambahan Input UserID Posisi Jaga
GroupBox2:AddInput("UserIDDepan", {
    Default = shared.PosisiJagaUserIDs.Depan,
    Text = "UserID1 Depan",
    Placeholder = "Contoh: 8802945328",
    Callback = function(Value)
        shared.PosisiJagaUserIDs.Depan = Value
        print("UserID Depan diatur ke:", Value)
    end,
})

GroupBox2:AddInput("UserIDBelakang", {
    Default = shared.PosisiJagaUserIDs.Belakang,
    Text = "UserID2 Belakang",
    Placeholder = "Contoh: 8802949363",
    Callback = function(Value)
        shared.PosisiJagaUserIDs.Belakang = Value
        print("UserID Belakang diatur ke:", Value)
    end,
})

GroupBox2:AddInput("UserIDKiri", {
    Default = shared.PosisiJagaUserIDs.Kiri,
    Text = "UserID3 Kiri",
    Placeholder = "Contoh: 8802939883",
    Callback = function(Value)
        shared.PosisiJagaUserIDs.Kiri = Value
        print("UserID Kiri diatur ke:", Value)
    end,
})

GroupBox2:AddInput("UserIDKanan", {
    Default = shared.PosisiJagaUserIDs.Kanan,
    Text = "UserID4 Kanan",
    Placeholder = "Contoh: 8802998147",
    Callback = function(Value)
        shared.PosisiJagaUserIDs.Kanan = Value
        print("UserID Kanan diatur ke:", Value)
    end,
})

-- ✅ Bot Setup
local function updateBotRefs()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    myRootPart = character:WaitForChild("HumanoidRootPart")
end

function setupBotFollowSystem()
    updateBotRefs()

    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player
        print("[INFO] Client ditemukan:", player.Name)

        followConnection = player.Chatted:Connect(function(msg)
            if msg == "!ikuti" then
                followAllowed = true
                Library:Notify("Perintah !ikuti diterima, bot mengikuti!", 3)

            elseif msg == "!stop" then
                followAllowed = false
                humanoid:MoveTo(myRootPart.Position)
                Library:Notify("Perintah !stop diterima, bot berhenti!", 3)

                -- Hapus posisi dari shared.GuardedPositions jika ada
                for i, pos in ipairs(shared.GuardedPositions) do
                    if (myRootPart.Position - pos).Magnitude < 1 then
                        table.remove(shared.GuardedPositions, i)
                        break
                    end
                end

            elseif msg == "!jaga" then
                followAllowed = false
                Library:Notify("Perintah !jaga diterima, mencari posisi jaga...", 3)

                if client and client.Character and client.Character:FindFirstChild("HumanoidRootPart") then
                    local targetHRP = client.Character:FindFirstChild("HumanoidRootPart")

                    local positions = {
                        targetHRP.Position + targetHRP.CFrame.LookVector * 5,    -- depan
                        targetHRP.Position - targetHRP.CFrame.LookVector * 5,    -- belakang
                        targetHRP.Position - targetHRP.CFrame.RightVector * 5,   -- kiri
                        targetHRP.Position + targetHRP.CFrame.RightVector * 5    -- kanan
                    }

                    local found = false
                    for i, pos in ipairs(positions) do
                        local blocked = false

                        -- Cek shared.GuardedPositions
                        for _, taken in pairs(shared.GuardedPositions) do
                            if (taken - pos).Magnitude < 2 then
                                blocked = true
                                break
                            end
                        end

                        -- Cek pemain lain
                        if not blocked then
                            for _, otherPlayer in ipairs(Players:GetPlayers()) do
                                if otherPlayer ~= localPlayer and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
                                    local otherHRP = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
                                    if (otherHRP.Position - pos).Magnitude < 3 then
                                        blocked = true
                                        break
                                    end
                                end
                            end
                        end

                        if not blocked then
                            humanoid:MoveTo(pos)
                            table.insert(shared.GuardedPositions, pos)

                            found = true
                            Library:Notify("Bot menjaga posisi ke-" .. i, 2)

                            task.delay(0.5, function()
                                if myRootPart then
                                    local lookDir = (myRootPart.Position - targetHRP.Position).Unit
                                    myRootPart.CFrame = CFrame.new(myRootPart.Position, myRootPart.Position + lookDir)
                                end
                            end)
                            break
                        end
                    end

                    if not found then
                        Library:Notify("Semua posisi jaga penuh!", 3)
                    end
                end
            end
        end)
    end

    for _, p in ipairs(Players:GetPlayers()) do
        setupClient(p)
    end

    Players.PlayerAdded:Connect(setupClient)
    localPlayer.CharacterAdded:Connect(updateBotRefs)

    loopTask = RunService.Heartbeat:Connect(function()
        if followAllowed and toggleAktif and client and client.Character and humanoid and myRootPart then
            local targetHRP = client.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local followPos = targetHRP.Position - targetHRP.CFrame.LookVector * jarakIkut
                local dist = (myRootPart.Position - followPos).Magnitude
                if dist > jarakMinimum then
                    humanoid:MoveTo(followPos)
                end
            end
        end
    end)
end
