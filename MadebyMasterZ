-- Library UI
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

local Window = Library:CreateWindow({
    Title = "MasterZ Toggle GUI",
    Footer = "v1.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "toggle-left"),
}

local GroupBox = Tabs.Main:AddLeftGroupbox("Toggle Section")

-- Tween + Trigger Setup
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function TweenTo(position, duration)
    local character = getCharacter()
    local hrp = character:WaitForChild("HumanoidRootPart")
    local tweenInfo = TweenInfo.new(duration or 1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
    local goal = { CFrame = CFrame.new(position) }
    local tween = TweenService:Create(hrp, tweenInfo, goal)
    tween:Play()
    tween.Completed:Wait()
end

local function TriggerPrompt(prompt)
    if prompt and prompt:IsA("ProximityPrompt") then
        fireproximityprompt(prompt)
    end
end

local function TriggerClick(clickDetector)
    if clickDetector and clickDetector:IsA("ClickDetector") then
        fireclickdetector(clickDetector)
    end
end

-- Fungsi utama
local function TeleportAndTrigger()
    local ctRooms = workspace:FindFirstChild("CTRooms")
    if not ctRooms then return end

    local models = ctRooms:GetChildren()
    if #models == 0 then return end

    -- Ambil satu model secara acak
    local model = models[math.random(1, #models)]
    local patient = model:FindFirstChild("PatientRadiology2")

    if patient and patient:FindFirstChild("Torso") then
        local torso = patient.Torso
        local prompt = torso:FindFirstChildWhichIsA("ProximityPrompt", true)

        if torso and prompt then
            -- Langkah 1: Teleport ke Torso dan trigger ProximityPrompt
            TweenTo(torso.Position + Vector3.new(0, 5, 0), 1)
            task.wait(0.5)
            TriggerPrompt(prompt)

            -- Langkah 2: Cari Union yang punya ClickDetector
            local targetUnion = nil
            for _, obj in ipairs(model:GetDescendants()) do
                if obj:IsA("UnionOperation") and obj:FindFirstChildWhichIsA("ClickDetector") then
                    targetUnion = obj
                    break
                end
            end

            if targetUnion then
                local click = targetUnion:FindFirstChildWhichIsA("ClickDetector")
                -- Langkah 3: Tween teleport ke Union dan trigger ClickDetector
                TweenTo(targetUnion.Position + Vector3.new(0, 5, 0), 1)
                task.wait(0.5)
                TriggerClick(click)
            end
        end
    end
end

-- Toggle Loop
local running = false

GroupBox:AddToggle("CTAuto", {
    Text = "Auto CT Teleport + Prompt + Click",
    Default = false,
    Tooltip = "Teleport ke CT, trigger prompt & click otomatis",
    Callback = function(state)
        running = state
        task.spawn(function()
            while running do
                TeleportAndTrigger()
                task.wait(2) -- jeda antar loop
            end
        end)
    end
})

-- Setup tema dan save
Library.ToggleKeybind = Options.MenuKeybind
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)

SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({ "MenuKeybind" })

ThemeManager:SetFolder("MyScriptHub")
SaveManager:SetFolder("MyScriptHub/specific-game")
SaveManager:SetSubFolder("specific-place")
SaveManager:BuildConfigSection(Tabs.Main)
