-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v2.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

-- ✅ Variabel Global
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

local clientName = ""
local jarakIkut = {
    default = 5,
    bot1 = 5,
    bot2 = 5,
    bot3 = 5,
    bot4 = 5,
    bot5 = 5
}
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false
local currentFormasiTarget = nil

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- ✅ Fungsi reset & stop
local function runStopCommand()
    followAllowed = false
    currentFormasiTarget = nil
    if humanoid and myRootPart then
        humanoid:MoveTo(myRootPart.Position)
    end
    Options.TextboxDisplayName:SetValue("")
    Options.TextboxFormasi1:SetValue("")
    Options.TextboxFormasi2:SetValue("")
    Options.TextboxFormasi3:SetValue("")
    Options.TextboxFormasi4:SetValue("")
    local args = { "leaveSync" }
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer(unpack(args))
    end)
    
    -- Stop pushup animation if playing
    local stopArgs = { "stopAnimation", "Push Up" }
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer(unpack(stopArgs))
    end)
    
    Library:Notify("❌ Bot dihentikan & textbox dikosongkan", 3)
end

-- [Previous UI setup code remains the same until the follow system]

-- ✅ Sistem Follow & Formasi
function setupBotFollowSystem()
    updateBotRefs()

    local function getBotDistance()
        local uid = tostring(localPlayer.UserId)
        local botDistances = {
            ["8802945328"] = jarakIkut.bot1,
            ["8802949363"] = jarakIkut.bot2,
            ["8802939883"] = jarakIkut.bot3,
            ["8802998147"] = jarakIkut.bot4,
            ["8802991722"] = jarakIkut.bot5
        }
        return botDistances[uid] or jarakIkut.default
    end

    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player

        followConnection = player.Chatted:Connect(function(msg)
            msg = msg:lower()
            local hrp = client.Character and client.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            if msg == "!stop" then
                runStopCommand()
            elseif msg == "!refresh" then
                fullRefresh()
            elseif msg:match("^!aturjarak ") then
                local newDistance = tonumber(msg:sub(11))
                if newDistance and newDistance > 0 then
                    jarakIkut.default = newDistance
                    Options.JarakIkutInput:SetValue(tostring(newDistance))
                    Library:Notify("✅ Jarak semua bot diatur ke: "..newDistance, 3)
                else
                    Library:Notify("❌ Masukkan angka yang valid (contoh: !aturjarak 5)", 3)
                end
            elseif msg:match("^!aturjarak1 ") then
                local newDistance = tonumber(msg:sub(12))
                if newDistance and newDistance > 0 then
                    jarakIkut.bot1 = newDistance
                    Library:Notify("✅ Jarak bot1 diatur ke: "..newDistance, 3)
                else
                    Library:Notify("❌ Masukkan angka yang valid (contoh: !aturjarak1 5)", 3)
                end
            elseif msg:match("^!aturjarak2 ") then
                local newDistance = tonumber(msg:sub(12))
                if newDistance and newDistance > 0 then
                    jarakIkut.bot2 = newDistance
                    Library:Notify("✅ Jarak bot2 diatur ke: "..newDistance, 3)
                else
                    Library:Notify("❌ Masukkan angka yang valid (contoh: !aturjarak2 5)", 3)
                end
            elseif msg:match("^!aturjarak3 ") then
                local newDistance = tonumber(msg:sub(12))
                if newDistance and newDistance > 0 then
                    jarakIkut.bot3 = newDistance
                    Library:Notify("✅ Jarak bot3 diatur ke: "..newDistance, 3)
                else
                    Library:Notify("❌ Masukkan angka yang valid (contoh: !aturjarak3 5)", 3)
                end
            elseif msg:match("^!aturjarak4 ") then
                local newDistance = tonumber(msg:sub(12))
                if newDistance and newDistance > 0 then
                    jarakIkut.bot4 = newDistance
                    Library:Notify("✅ Jarak bot4 diatur ke: "..newDistance, 3)
                else
                    Library:Notify("❌ Masukkan angka yang valid (contoh: !aturjarak4 5)", 3)
                end
            elseif msg:match("^!aturjarak5 ") then
                local newDistance = tonumber(msg:sub(12))
                if newDistance and newDistance > 0 then
                    jarakIkut.bot5 = newDistance
                    Library:Notify("✅ Jarak bot5 diatur ke: "..newDistance, 3)
                else
                    Library:Notify("❌ Masukkan angka yang valid (contoh: !aturjarak5 5)", 3)
                end
            -- [Rest of your existing command handlers...]
            end
        end)
    end

    -- [Rest of your existing setup code...]

    loopTask = RunService.Heartbeat:Connect(function()
        if followAllowed and toggleAktif and currentFormasiTarget and currentFormasiTarget.Character and humanoid and myRootPart then
            local targetHRP = currentFormasiTarget.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local currentDistance = getBotDistance()
                local followPos = targetHRP.Position - targetHRP.CFrame.LookVector * currentDistance
                local dist = (myRootPart.Position - followPos).Magnitude
                if dist > jarakMinimum then
                    myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, targetHRP.Position)
                    humanoid:MoveTo(followPos)
                end
            end
        end
    end)
end
