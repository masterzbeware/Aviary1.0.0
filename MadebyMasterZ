local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v2.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user"),
}

-- Variabel Global
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

local clientName = ""
local jarakIkut = 5
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- UI LEFT
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")

GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Aktifkan Bot Follow",
    Default = false,
    Tooltip = "Nyalakan agar bot siap menerima perintah !ikuti",
    Callback = function(Value)
        toggleAktif = Value

        if Value then
            Library:Notify("Bot Follow Diaktifkan", 3)
            if followConnection then followConnection:Disconnect() end
            if loopTask then loopTask:Disconnect() end
            setupBotFollowSystem()
        else
            Library:Notify("Bot Follow Dimatikan", 3)
            followAllowed = false
            if loopTask then loopTask:Disconnect() end
            if followConnection then followConnection:Disconnect() end
            if humanoid and myRootPart then
                humanoid:MoveTo(myRootPart.Position)
            end
        end
    end,
})

GroupBox1:AddInput("NamaClientInput", {
    Default = "",
    Text = "Nama Client",
    Placeholder = "Contoh: MasterZ_YT",
    Callback = function(Value)
        clientName = Value
        print("Client diatur ke:", clientName)
    end,
})

local GroupBox3 = Tabs.Main:AddLeftGroupbox("Textbox")

GroupBox3:AddInput("TextboxDisplayName", {
    Default = "",
    Text = "Target DisplayName",
    Placeholder = "Kosong",
    Callback = function(Value)
        print("DisplayName target:", Value)
    end,
})

GroupBox3:AddInput("TextboxFormasi1", {
    Default = "",
    Text = "Formasi 1 Target",
    Placeholder = "Kosong",
    Callback = function(Value)
        print("Formasi 1 Target:", Value)
    end,
})

GroupBox3:AddInput("TextboxFormasi2", {
    Default = "",
    Text = "Formasi 2 Target",
    Placeholder = "Kosong",
    Callback = function(Value)
        print("Formasi 2 Target:", Value)
    end,
})

GroupBox3:AddInput("TextboxFormasi3", {
    Default = "",
    Text = "Formasi 3 Target",
    Placeholder = "Kosong",
    Callback = function(Value)
        print("Formasi 3 Target:", Value)
    end,
})

local GroupBox2 = Tabs.Main:AddRightGroupbox("Pengaturan Jarak")

GroupBox2:AddInput("JarakIkutInput", {
    Default = "5",
    Text = "Jarak Bot",
    Placeholder = "Contoh: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakIkut = number
        end
    end,
})

GroupBox2:AddInput("JarakMinimumInput", {
    Default = "2",
    Text = "Jarak Minimum Bergerak",
    Placeholder = "Contoh: 2",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakMinimum = number
        end
    end,
})

local function updateBotRefs()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    myRootPart = character:WaitForChild("HumanoidRootPart")
end

function setupBotFollowSystem()
    updateBotRefs()

    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player

        followConnection = player.Chatted:Connect(function(msg)
            msg = msg:lower()
            local hrp = client.Character and client.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            if msg == "!stop" then
                followAllowed = false
                humanoid:MoveTo(myRootPart.Position)
                Library:Notify("Bot berhenti & keluar dari sync", 3)

            elseif msg == "!gabung" then
                followAllowed = false
                Library:Notify("Perintah !gabung diterima", 3)

            elseif msg:match("^!ikuti ") then
                local targetDisplayName = msg:sub(8):lower()
                for _, p in ipairs(Players:GetPlayers()) do
                    if p.DisplayName:lower() == targetDisplayName then
                        client = p
                        followAllowed = true
                        Options.TextboxDisplayName:SetValue(p.DisplayName)
                        Library:Notify("Mengikuti: " .. p.DisplayName, 3)
                        break
                    end
                end

            elseif msg == "!ikuti" then
                followAllowed = true
                Options.TextboxDisplayName:SetValue("")
                Library:Notify("Bot mengikuti client", 3)

            elseif msg:match("^!formasi[123]") then
                followAllowed = false
                local formasiCmd, displayNameRaw = msg:match("^!(formasi[123])%s*(.*)")
                local displayName = displayNameRaw and displayNameRaw:match("^%s*(.-)%s*$"):lower() or ""
                local target = nil

                if displayName ~= "" then
                    for _, p in ipairs(Players:GetPlayers()) do
                        if p.DisplayName:lower() == displayName then
                            target = p
                            client = p
                            break
                        end
                    end
                    if formasiCmd == "formasi1" then Options.TextboxFormasi1:SetValue(target and target.DisplayName or "")
                    elseif formasiCmd == "formasi2" then Options.TextboxFormasi2:SetValue(target and target.DisplayName or "")
                    elseif formasiCmd == "formasi3" then Options.TextboxFormasi3:SetValue(target and target.DisplayName or "")
                    end
                else
                    target = client
                    if formasiCmd == "formasi1" then Options.TextboxFormasi1:SetValue("")
                    elseif formasiCmd == "formasi2" then Options.TextboxFormasi2:SetValue("")
                    elseif formasiCmd == "formasi3" then Options.TextboxFormasi3:SetValue("")
                    end
                end

                if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                    hrp = target.Character.HumanoidRootPart
                    local uid = tostring(localPlayer.UserId)
                    local formasi = {}

                    if formasiCmd == "formasi1" then
                        formasi = {
                            ["8802945328"] = hrp.Position + hrp.CFrame.LookVector * 5,
                            ["8802949363"] = hrp.Position + hrp.CFrame.RightVector * 5,
                            ["8802939883"] = hrp.Position - hrp.CFrame.RightVector * 5,
                            ["8802998147"] = hrp.Position - hrp.CFrame.LookVector * 5,
                            ["8802991722"] = hrp.Position + Vector3.new(0, 0, -7),
                        }
                    elseif formasiCmd == "formasi2" then
                        formasi = {
                            ["8802945328"] = hrp.Position + hrp.CFrame.LookVector * 4 + hrp.CFrame.RightVector * 4,
                            ["8802949363"] = hrp.Position + hrp.CFrame.LookVector * 4 - hrp.CFrame.RightVector * 4,
                            ["8802939883"] = hrp.Position - hrp.CFrame.LookVector * 4 + hrp.CFrame.RightVector * 4,
                            ["8802998147"] = hrp.Position - hrp.CFrame.LookVector * 4 - hrp.CFrame.RightVector * 4,
                            ["8802991722"] = hrp.Position,
                        }
                    elseif formasiCmd == "formasi3" then
                        formasi = {
                            ["8802945328"] = hrp.Position + hrp.CFrame.LookVector * 4 - hrp.CFrame.RightVector * 6,
                            ["8802949363"] = hrp.Position + hrp.CFrame.LookVector * 4 - hrp.CFrame.RightVector * 2,
                            ["8802939883"] = hrp.Position + hrp.CFrame.LookVector * 4 + hrp.CFrame.RightVector * 2,
                            ["8802998147"] = hrp.Position + hrp.CFrame.LookVector * 4 + hrp.CFrame.RightVector * 6,
                            ["8802991722"] = hrp.Position + hrp.CFrame.LookVector * 6,
                        }
                    end

                    local targetPos = formasi[uid]
                    if targetPos then
                        myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, hrp.Position)
                        humanoid:MoveTo(targetPos)
                    end
                else
                    Library:Notify("âŒ Target tidak ditemukan!", 3)
                end
            end
        end)
    end

    for _, p in ipairs(Players:GetPlayers()) do setupClient(p) end
    Players.PlayerAdded:Connect(setupClient)
    localPlayer.CharacterAdded:Connect(updateBotRefs)

    loopTask = RunService.Heartbeat:Connect(function()
        if followAllowed and toggleAktif and client and client.Character and humanoid and myRootPart then
            local targetHRP = client.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local followPos = targetHRP.Position - targetHRP.CFrame.LookVector * jarakIkut
                local dist = (myRootPart.Position - followPos).Magnitude
                if dist > jarakMinimum then
                    myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, targetHRP.Position)
                    humanoid:MoveTo(followPos)
                end
            end
        end
    end)
end
