-- Library UI
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

local Window = Library:CreateWindow({
    Title = "MasterZ Toggle GUI",
    Footer = "v1.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "toggle-left"),
}

local GroupBox = Tabs.Main:AddLeftGroupbox("Toggle Section")

-- Tween + Trigger Setup
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function TweenTo(position, duration)
    local character = getCharacter()
    local hrp = character:WaitForChild("HumanoidRootPart")
    local tweenInfo = TweenInfo.new(duration or 1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
    local goal = { CFrame = CFrame.new(position) }
    local tween = TweenService:Create(hrp, tweenInfo, goal)
    tween:Play()
    tween.Completed:Wait()
end

local function TriggerPrompt(prompt)
    if prompt and prompt:IsA("ProximityPrompt") then
        fireproximityprompt(prompt)
    end
end

local function TriggerClick(clickDetector)
    if clickDetector and clickDetector:IsA("ClickDetector") then
        fireclickdetector(clickDetector)
    end
end

-- Fungsi utama
local function TeleportAndTrigger()
    local ctRooms = workspace:FindFirstChild("CTRooms")
    if not ctRooms then return end

    local models = ctRooms:GetChildren()
    if #models == 0 then return end

    -- Ambil satu model secara acak
    local model = models[math.random(1, #models)]
    local patient = model:FindFirstChild("PatientRadiology2")

    if patient and patient:FindFirstChild("Torso") then
        local torso = patient.Torso
        local prompt = torso:FindFirstChildWhichIsA("ProximityPrompt", true)

        if torso and prompt then
            -- Langkah 1: Teleport ke Torso pertama dan trigger
            TweenTo(torso.Position + Vector3.new(0, 5, 0), 1)
            task.wait(0.5)
            TriggerPrompt(prompt)

            -- Langkah 2: Cari Union dengan ClickDetector
            local targetUnion = nil
            for _, obj in ipairs(model:GetDescendants()) do
                if obj:IsA("UnionOperation") and obj:FindFirstChildWhichIsA("ClickDetector") then
                    targetUnion = obj
                    break
                end
            end

            if targetUnion then
                local click = targetUnion:FindFirstChildWhichIsA("ClickDetector")
                TweenTo(targetUnion.Position + Vector3.new(0, 5, 0), 1)
                task.wait(0.5)
                TriggerClick(click)

                -- Langkah 3: Cari Part dalam X-Ray Button yang punya ProximityPrompt
                local xrayButtonModel = model:FindFirstChild("X-Ray Button")
                if xrayButtonModel then
                    local targetPart = nil
                    for _, part in ipairs(xrayButtonModel:GetChildren()) do
                        if part:IsA("BasePart") and part:FindFirstChildWhichIsA("ProximityPrompt") then
                            targetPart = part
                            break
                        end
                    end

                    if targetPart then
                        local prompt2 = targetPart:FindFirstChildWhichIsA("ProximityPrompt")
                        TweenTo(targetPart.Position + Vector3.new(0, 5, 0), 1)
                        task.wait(0.5)
                        TriggerPrompt(prompt2)

                        -- Langkah 4: Tunggu 17 detik
                        task.wait(17)

                        -- Langkah 5: Kembali ke Torso dan trigger lagi
                        TweenTo(torso.Position + Vector3.new(0, 5, 0), 1)
                        task.wait(0.5)
                        TriggerPrompt(prompt)
                    end
                end
            end
        end
    end
end

-- Toggle Loop
local running = false

GroupBox:AddToggle("CTAuto", {
    Text = "Auto CT Full Loop",
    Default = false,
    Tooltip = "CT: prompt > click > x-ray > balik prompt",
    Callback = function(state)
        running = state
        task.spawn(function()
            while running do
                TeleportAndTrigger()
                task.wait(2)
            end
        end)
    end
})

-- Keybind buka tutup menu
Library.ToggleKeybind = Options.MenuKeybind
