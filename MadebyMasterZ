-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v21.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

-- ✅ Global Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

local clientName = "FiestaGuardVip"  -- Semua diatur oleh client ini
local jarakIkut = 5
local jarakFormasi = 5
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false
local currentFormasiTarget = nil
local currentFormation = nil

local botSettings = {
    ["8802945328"] = {followDistance = 5, minDistance = 2},
    ["8802949363"] = {followDistance = 5, minDistance = 2},
    ["8802939883"] = {followDistance = 5, minDistance = 2},
    ["8802998147"] = {followDistance = 5, minDistance = 2},
    ["8802991722"] = {followDistance = 5, minDistance = 2}
}

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- ✅ Debug function
local function debugPrint(msg)
    print("[DEBUG] "..msg)
end

-- ✅ Reset & Stop Function
local function runStopCommand()
    followAllowed = false
    currentFormasiTarget = nil
    currentFormation = nil
    if humanoid and myRootPart then
        humanoid:MoveTo(myRootPart.Position)
    end
    Options.TextboxDisplayName:SetValue("")
    Options.TextboxFormasi1:SetValue("")
    Options.TextboxFormasi2:SetValue("")
    Options.TextboxFormasi3:SetValue("")
    Options.TextboxFormasi4:SetValue("")

    local args = { "leaveSync" }
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer(unpack(args))
    end)
    
    local stopArgs = { "stopAnimation", "Push Up" }
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer(unpack(stopArgs))
    end)
    
    Library:Notify("❌ Bot stopped & textboxes cleared", 3)
    debugPrint("Bot stopped")
end

-- ✅ Restart Bot Function
local function restartBot()
    runStopCommand()
    if followConnection then followConnection:Disconnect() end
    if loopTask then loopTask:Disconnect() end
    task.wait(0.5)
    if toggleAktif then
        setupBotFollowSystem()
        Library:Notify("✅ Bot restarted with client: "..clientName, 5)
        debugPrint("Bot restarted")
    end
end

-- ✅ UI LEFT - Main Tab
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")

GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Enable Bot Follow",
    Default = false,
    Tooltip = "Enable to accept !ikuti commands",
    Callback = function(Value)
        toggleAktif = Value
        if Value then
            Library:Notify("Bot Follow Enabled", 3)
            debugPrint("Toggle ON")
            if followConnection then followConnection:Disconnect() end
            if loopTask then loopTask:Disconnect() end
            setupBotFollowSystem()
        else
            Library:Notify("Bot Follow Disabled", 3)
            debugPrint("Toggle OFF")
            runStopCommand()
            if loopTask then loopTask:Disconnect() end
            if followConnection then followConnection:Disconnect() end
        end
    end,
})

GroupBox1:AddInput("NamaClientInput", {
    Default = clientName,
    Text = "Client Name",
    Placeholder = "Example: FiestaGuardVip",
    Callback = function(Value)
        clientName = Value
        debugPrint("Client set to: "..clientName)
    end,
})

GroupBox1:AddInput("JarakFormasiInput", {
    Default = "5",
    Text = "Formation Distance",
    Placeholder = "Example: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakFormasi = number
            Library:Notify("Formation distance set to: "..number, 3)
            debugPrint("JarakFormasi di-set ke "..number)
        end
    end,
})

-- ✅ Textboxes
local GroupBox3 = Tabs.Main:AddLeftGroupbox("Textbox")
GroupBox3:AddInput("TextboxDisplayName", {Default = "", Text = "Target DisplayName", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi1", {Default = "", Text = "Formation 1 Target", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi2", {Default = "", Text = "Formation 2 Target", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi3", {Default = "", Text = "Formation 3 Target", Placeholder = "Empty", Callback = function(Value) end})
GroupBox3:AddInput("TextboxFormasi4", {Default = "", Text = "Formation 4 Target", Placeholder = "Empty", Callback = function(Value) end})

-- ✅ UI RIGHT - Distance Settings
local GroupBox2 = Tabs.Main:AddRightGroupbox("Distance Settings")
GroupBox2:AddInput("JarakIkutInput", {
    Default = "5",
    Text = "Follow Distance",
    Placeholder = "Example: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakIkut = number
            Library:Notify("Follow distance set to: "..number, 3)
            debugPrint("jarakIkut di-set ke "..number)
        end
    end,
})
GroupBox2:AddInput("JarakMinimumInput", {
    Default = "2",
    Text = "Minimum Move Distance",
    Placeholder = "Example: 2",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakMinimum = number
            Library:Notify("Minimum distance set to: "..number, 3)
            debugPrint("jarakMinimum di-set ke "..number)
        end
    end,
})

-- ✅ Helper Functions
local function updateBotRefs()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    myRootPart = character:WaitForChild("HumanoidRootPart")
    debugPrint("Bot refs updated (Humanoid & RootPart siap)")
end

local function fullRefresh()
    runStopCommand()
    task.wait(0.5)
    currentFormasiTarget = nil
    followAllowed = false
    if followConnection then followConnection:Disconnect() end
    if loopTask then loopTask:Disconnect() end
    if toggleAktif then
        setupBotFollowSystem()
    end
    Library:Notify("✅ System refreshed", 3)
    debugPrint("System refreshed")
end

-- Function to calculate formation position
local function getFormationPosition(targetHRP, formationType)
    local uid = tostring(localPlayer.UserId)
    local formasi = {}
    
    if formationType == "formasi1" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.RightVector * jarakFormasi),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.RightVector * -jarakFormasi),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi),
            ["8802991722"] = targetHRP.Position + Vector3.new(0, 0, -jarakFormasi)
        }
    elseif formationType == "formasi2" then
        local diagonalDist = jarakFormasi * 0.7071
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * diagonalDist) + (targetHRP.CFrame.RightVector * diagonalDist),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.LookVector * diagonalDist) + (targetHRP.CFrame.RightVector * -diagonalDist),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -diagonalDist) + (targetHRP.CFrame.RightVector * diagonalDist),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -diagonalDist) + (targetHRP.CFrame.RightVector * -diagonalDist),
            ["8802991722"] = targetHRP.Position
        }
    elseif formationType == "formasi3" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * -jarakFormasi*1.5),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * -jarakFormasi*0.5),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * jarakFormasi*0.5),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi) + (targetHRP.CFrame.RightVector * jarakFormasi*1.5),
            ["8802991722"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi*1.2)
        }
    elseif formationType == "formasi4" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * jarakFormasi*1.5),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * jarakFormasi*0.75),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * -jarakFormasi*0.75),
            ["8802991722"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi*0.75) + (targetHRP.CFrame.RightVector * -jarakFormasi*1.5)
        }
    end
    return formasi[uid]
end

-- ✅ Follow System
function setupBotFollowSystem()
    updateBotRefs()

    local function setupClient(player)
        if player.Name ~= clientName then
            debugPrint("Player "..player.Name.." bukan client, di-skip")
            return
        end
        client = player
        debugPrint("Client ditemukan: "..player.Name)

        followConnection = player.Chatted:Connect(function(msg)
            msg = msg:lower()
            debugPrint("Client chat: "..msg)

            local hrp = client.Character and client.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then
                debugPrint("HumanoidRootPart client belum ada!")
                return
            end

            if msg == "!ikuti" then
                followAllowed = true
                currentFormasiTarget = client
                debugPrint("Bot siap mengikuti "..client.Name)
            elseif msg == "!stop" then
                runStopCommand()
            elseif msg == "!refresh" then
                fullRefresh()
            elseif msg == "!pushup" then
                runStopCommand()
                local args = {"playAnimation","Push Up"}
                pcall(function()
                    ReplicatedStorage:WaitForChild("Connections")
                        :WaitForChild("dataProviders")
                        :WaitForChild("animationHandler")
                        :InvokeServer(unpack(args))
                end)
                Library:Notify("✅ Bot doing push up",3)
                debugPrint("Bot push up")
            elseif msg:match("^!formasi[1234]") then
                runStopCommand()
                local formasiCmd, displayName = msg:match("^!(formasi[1234])%s*(.*)")
                local target = client
                if displayName ~= "" then
                    for _, p in ipairs(Players:GetPlayers()) do
                        if p.DisplayName:lower() == displayName:lower() then
                            target = p
                            break
                        end
                    end
                end
                if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = target.Character.HumanoidRootPart
                    local posisiTarget = getFormationPosition(hrp, formasiCmd)
                    if posisiTarget then
                        currentFormation = formasiCmd
                        myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, hrp.Position)
                        humanoid:MoveTo(posisiTarget)
                        -- Update textbox
                        if formasiCmd=="formasi1" then Options.TextboxFormasi1:SetValue(target.DisplayName)
                        elseif formasiCmd=="formasi2" then Options.TextboxFormasi2:SetValue(target.DisplayName)
                        elseif formasiCmd=="formasi3" then Options.TextboxFormasi3:SetValue(target.DisplayName)
                        elseif formasiCmd=="formasi4" then Options.TextboxFormasi4:SetValue(target.DisplayName) end
                        Library:Notify("✅ Formation set: "..formasiCmd,3)
                        debugPrint("Formation "..formasiCmd.." aktif")
                    end
                end
            end
        end)
    end

    -- Setup existing players
    for _, player in ipairs(Players:GetPlayers()) do
        setupClient(player)
    end

    -- Setup new players
    Players.PlayerAdded:Connect(setupClient)

    localPlayer.CharacterAdded:Connect(updateBotRefs)

    loopTask = RunService.Heartbeat:Connect(function()
        if not toggleAktif then return end
        if not currentFormasiTarget then debugPrint("Tidak ada target untuk diikuti") return end
        if not currentFormasiTarget.Character then debugPrint("Target belum spawn") return end
        if not humanoid or not myRootPart then debugPrint("Bot belum siap") return end

        local targetHRP = currentFormasiTarget.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then debugPrint("Target HumanoidRootPart tidak ditemukan") return end

        if followAllowed then
            if currentFormation then
                local formationPos = getFormationPosition(targetHRP,currentFormation)
                if formationPos then
                    local dist = (myRootPart.Position-formationPos).Magnitude
                    if dist > jarakMinimum then
                        myRootPart.CFrame = CFrame.lookAt(myRootPart.Position,targetHRP.Position)
                        humanoid:MoveTo(formationPos)
                        debugPrint("Bot bergerak ke formation: "..tostring(formationPos))
                    end
                end
            else
                local followPos = targetHRP.Position - targetHRP.CFrame.LookVector * jarakIkut
                local dist = (myRootPart.Position-followPos).Magnitude
                if dist > jarakMinimum then
                    myRootPart.CFrame = CFrame.lookAt(myRootPart.Position,targetHRP.Position)
                    humanoid:MoveTo(followPos)
                    debugPrint("Bot bergerak ke: "..tostring(followPos))
                else
                    debugPrint("Bot dekat target, tidak bergerak")
                end
            end
        end
    end)
end
