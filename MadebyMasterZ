-- ‚úÖ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v21.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

-- ‚úÖ Global Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local PathfindingService = game:GetService("PathfindingService")
local localPlayer = Players.LocalPlayer

-- Verifikasi PathfindingService
if not PathfindingService:IsA("PathfindingService") then
    Library:Notify("‚ùå PathfindingService tidak aktif di game ini!", 5)
    return
end

-- Config
local clientName = ""
local jarakIkut = 5
local jarakFormasi = 5
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false
local currentFormasiTarget = nil
local adminName = "bodyguardshoprblx"
local pathfindCooldown = 0.5
local lastPathfindTime = 0

-- Bot Settings
local botSettings = {
    ["8802945328"] = {followDistance = 5, minDistance = 2},
    ["8802949363"] = {followDistance = 5, minDistance = 2},
    ["8802939883"] = {followDistance = 5, minDistance = 2},
    ["8802998147"] = {followDistance = 5, minDistance = 2},
    ["8802991722"] = {followDistance = 5, minDistance = 2}
}

-- References
local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil
local currentPath = nil
local waypoints = nil
local currentWaypointIndex = nil

-- ‚úÖ Pathfinding Functions
local function computePath(targetPosition)
    if not myRootPart then return nil end
    
    local path = PathfindingService:CreatePath({
        AgentRadius = 2,
        AgentHeight = 5,
        AgentCanJump = true,
        WaypointSpacing = 2,
        Costs = {
            Water = 20,
            Lava = 30
        }
    })
    
    local success, errorMessage = pcall(function()
        path:ComputeAsync(myRootPart.Position, targetPosition)
    end)
    
    if not success then
        Library:Notify("‚ùå Error Pathfinding: "..tostring(errorMessage), 3)
        return nil
    end
    
    return path
end

local function followPath(targetPosition)
    if not humanoid or not myRootPart then 
        Library:Notify("‚ùå Humanoid/RootPart tidak ditemukan!", 3)
        return false 
    end
    
    -- Cooldown check
    local now = tick()
    if now - lastPathfindTime < pathfindCooldown then
        return false
    end
    lastPathfindTime = now
    
    -- Clear old path
    if currentPath then
        currentPath:Destroy()
        currentPath = nil
    end
    
    -- Compute new path
    currentPath = computePath(targetPosition)
    if not currentPath then
        Library:Notify("‚ö†Ô∏è Gunakan gerak langsung (Pathfinding gagal)", 2)
        humanoid:MoveTo(targetPosition)
        return false
    end
    
    -- Get waypoints
    waypoints = currentPath:GetWaypoints()
    if #waypoints == 0 then
        Library:Notify("‚ùå Tidak ada waypoint yang ditemukan", 3)
        return false
    end
    
    -- Start following
    currentWaypointIndex = 1
    humanoid:MoveTo(waypoints[currentWaypointIndex].Position)
    
    Library:Notify(string.format("üîÑ Mulai path (%d waypoints)", #waypoints), 2)
    return true
end

local function updatePathFollowing()
    if not waypoints or not currentWaypointIndex or not humanoid or not myRootPart then 
        return 
    end
    
    local currentWaypoint = waypoints[currentWaypointIndex]
    local distance = (myRootPart.Position - currentWaypoint.Position).Magnitude
    
    if distance < 2.5 then
        -- Handle jumping
        if currentWaypoint.Action == Enum.PathWaypointAction.Jump then
            humanoid.Jump = true
        end
        
        -- Move to next waypoint
        currentWaypointIndex += 1
        
        if currentWaypointIndex <= #waypoints then
            humanoid:MoveTo(waypoints[currentWaypointIndex].Position)
        else
            -- Path complete
            waypoints = nil
            currentWaypointIndex = nil
            if currentPath then
                currentPath:Destroy()
                currentPath = nil
            end
            Library:Notify("‚úÖ Sampai di tujuan", 2)
        end
    end
end

-- ‚úÖ Movement Functions
local function moveToPosition(targetPosition)
    if not humanoid or not myRootPart then return end
    
    -- Cek jarak minimum
    local distance = (myRootPart.Position - targetPosition).Magnitude
    if distance < jarakMinimum then return end
    
    -- Coba pathfinding dulu
    local pathSuccess = followPath(targetPosition)
    
    -- Fallback ke sistem lama jika pathfinding gagal
    if not pathSuccess then
        humanoid:MoveTo(targetPosition)
    end
end

-- ‚úÖ Bot Control Functions
local function runStopCommand()
    followAllowed = false
    currentFormasiTarget = nil
    
    -- Clear pathfinding
    if currentPath then
        currentPath:Destroy()
        currentPath = nil
    end
    waypoints = nil
    currentWaypointIndex = nil
    
    -- Stop movement
    if humanoid and myRootPart then
        humanoid:MoveTo(myRootPart.Position)
    end
    
    -- Clear UI
    Options.TextboxDisplayName:SetValue("")
    Options.TextboxFormasi1:SetValue("")
    Options.TextboxFormasi2:SetValue("")
    Options.TextboxFormasi3:SetValue("")
    Options.TextboxFormasi4:SetValue("")
    
    -- Stop animations
    pcall(function()
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer("leaveSync")
            
        ReplicatedStorage:WaitForChild("Connections")
            :WaitForChild("dataProviders")
            :WaitForChild("animationHandler")
            :InvokeServer("stopAnimation", "Push Up")
    end)
    
    Library:Notify("‚ùå Bot dihentikan", 3)
end

local function updateBotRefs()
    local character = localPlayer.Character
    if not character then
        character = localPlayer.CharacterAdded:Wait()
    end
    
    humanoid = character:FindFirstChildOfClass("Humanoid") or character:WaitForChild("Humanoid")
    myRootPart = character:FindFirstChild("HumanoidRootPart") or character:WaitForChild("HumanoidRootPart")
    
    -- Ensure humanoid is active
    humanoid:ChangeState(Enum.HumanoidStateType.Running)
end

local function fullRefresh()
    runStopCommand()
    task.wait(0.5)
    
    if followConnection then followConnection:Disconnect() end
    if loopTask then loopTask:Disconnect() end
    
    updateBotRefs()
    
    if toggleAktif then
        setupBotFollowSystem()
    end
    
    Library:Notify("‚úÖ Sistem direfresh", 3)
end

-- ‚úÖ UI Setup
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")

GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Enable Bot Follow",
    Default = false,
    Tooltip = "Enable to accept !ikuti commands",
    Callback = function(Value)
        toggleAktif = Value
        if Value then
            Library:Notify("Bot Follow Enabled", 3)
            setupBotFollowSystem()
        else
            Library:Notify("Bot Follow Disabled", 3)
            runStopCommand()
        end
    end,
})

GroupBox1:AddInput("NamaClientInput", {
    Default = "",
    Text = "Client Name",
    Placeholder = "Example: MasterZ_YT",
    Callback = function(Value)
        clientName = Value
        Library:Notify("Client set to: "..Value, 3)
    end,
})

GroupBox1:AddInput("AdminName", {
    Default = "bodyguardshoprblx",
    Text = "Admin Name",
    Placeholder = "bodyguardshoprblx",
    Callback = function(Value)
        adminName = Value
        Library:Notify("Admin Name set to: "..Value, 3)
    end,
})

GroupBox1:AddInput("JarakFormasiInput", {
    Default = "5",
    Text = "Formation Distance",
    Placeholder = "Example: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakFormasi = number
            Library:Notify("Formation distance set to: "..number, 3)
        end
    end,
})

-- Textbox Group
local GroupBox3 = Tabs.Main:AddLeftGroupbox("Textbox")

GroupBox3:AddInput("TextboxDisplayName", {
    Default = "",
    Text = "Target DisplayName",
    Placeholder = "Empty",
})

GroupBox3:AddInput("TextboxFormasi1", {
    Default = "",
    Text = "Formation 1 Target",
    Placeholder = "Empty",
})

GroupBox3:AddInput("TextboxFormasi2", {
    Default = "",
    Text = "Formation 2 Target",
    Placeholder = "Empty",
})

GroupBox3:AddInput("TextboxFormasi3", {
    Default = "",
    Text = "Formation 3 Target",
    Placeholder = "Empty",
})

GroupBox3:AddInput("TextboxFormasi4", {
    Default = "",
    Text = "Formation 4 Target",
    Placeholder = "Empty",
})

-- Distance Settings
local GroupBox2 = Tabs.Main:AddRightGroupbox("Distance Settings")

GroupBox2:AddInput("JarakIkutInput", {
    Default = "5",
    Text = "Follow Distance",
    Placeholder = "Example: 5",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakIkut = number
            Library:Notify("Follow distance set to: "..number, 3)
        end
    end,
})

GroupBox2:AddInput("JarakMinimumInput", {
    Default = "2",
    Text = "Minimum Move Distance",
    Placeholder = "Example: 2",
    Callback = function(Value)
        local number = tonumber(Value)
        if number then
            jarakMinimum = number
            Library:Notify("Minimum distance set to: "..number, 3)
        end
    end,
})

-- ‚úÖ Main Bot System
function setupBotFollowSystem()
    updateBotRefs()

    -- Handle admin commands
    local function handleAdminCommand(player, msg)
        if player.Name ~= adminName then return false end
        
        msg = msg:lower()
        local currentBotID = tostring(localPlayer.UserId)
        
        -- !clientname command
        if msg:match("^!clientname ") then
            local newName = msg:sub(12):gsub("^%s*(.-)%s*$", "%1")
            if newName ~= "" then
                clientName = newName
                Options.NamaClientInput:SetValue(newName)
                Library:Notify("Admin changed client to: "..newName, 5)
                fullRefresh()
                return true
            end
        end
        
        -- Distance settings
        for i = 1, 5 do
            if msg:match("^!aturjarak"..i.."%s") then
                local distance = tonumber(msg:match("%d+$"))
                if distance then
                    local botID = ""
                    if i == 1 then botID = "8802945328"
                    elseif i == 2 then botID = "8802949363"
                    elseif i == 3 then botID = "8802939883"
                    elseif i == 4 then botID = "8802998147"
                    elseif i == 5 then botID = "8802991722" end
                    
                    botSettings[botID].followDistance = distance
                    
                    if currentBotID == botID then
                        jarakIkut = distance
                        Options.JarakIkutInput:SetValue(tostring(distance))
                    end
                    
                    Library:Notify(string.format("BotID%d distance set to: %d", i, distance), 5)
                    return true
                end
            end
            
            if msg:match("^!minjarak"..i.."%s") then
                local minDistance = tonumber(msg:match("%d+$"))
                if minDistance then
                    local botID = ""
                    if i == 1 then botID = "8802945328"
                    elseif i == 2 then botID = "8802949363"
                    elseif i == 3 then botID = "8802939883"
                    elseif i == 4 then botID = "8802998147"
                    elseif i == 5 then botID = "8802991722" end
                    
                    botSettings[botID].minDistance = minDistance
                    
                    if currentBotID == botID then
                        jarakMinimum = minDistance
                        Options.JarakMinimumInput:SetValue(tostring(minDistance))
                    end
                    
                    Library:Notify(string.format("BotID%d min distance set to: %d", i, minDistance), 5)
                    return true
                end
            end
        end
        return false
    end

    -- Setup client commands
    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player

        followConnection = player.Chatted:Connect(function(msg)
            -- Admin commands first
            if handleAdminCommand(player, msg) then return end
            
            msg = msg:lower()
            local hrp = client.Character and client.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            if msg == "!stop" then
                runStopCommand()
            elseif msg == "!refresh" then
                fullRefresh()
            elseif msg == "!gabung" then
                followAllowed = false
                pcall(function()
                    ReplicatedStorage:WaitForChild("Connections")
                        :WaitForChild("dataProviders")
                        :WaitForChild("commandHandler")
                        :InvokeServer("sync", client.UserId)
                end)
                Library:Notify("‚úÖ Bergabung dengan client", 3)
            elseif msg == "!ikuti" then
                followAllowed = true
                currentFormasiTarget = client
                Options.TextboxDisplayName:SetValue("")
                Library:Notify("Mengikuti client utama", 3)
            elseif msg:match("^!ikuti ") then
                local targetDisplayName = msg:sub(8)
                local foundTarget = nil
                
                for _, p in ipairs(Players:GetPlayers()) do
                    if p.DisplayName:lower() == targetDisplayName:lower() then
                        foundTarget = p
                        break
                    end
                end
                
                if foundTarget then
                    followAllowed = true
                    currentFormasiTarget = foundTarget
                    Options.TextboxDisplayName:SetValue(foundTarget.DisplayName)
                    Library:Notify("Mengikuti: "..foundTarget.DisplayName, 3)
                else
                    Library:Notify("‚ùå Target tidak ditemukan", 3)
                end
            elseif msg == "!pushup" then
                pcall(function()
                    ReplicatedStorage:WaitForChild("Connections")
                        :WaitForChild("dataProviders")
                        :WaitForChild("animationHandler")
                        :InvokeServer("playAnimation", "Push Up")
                end)
                Library:Notify("‚úÖ Memulai push up", 3)
            elseif msg:match("^!formasi[1234]") then
                local formasiCmd, displayName = msg:match("^!(formasi[1234])%s*(.*)")
                
                local target = nil
                if displayName and displayName ~= "" then
                    for _, p in ipairs(Players:GetPlayers()) do
                        if p.DisplayName:lower() == displayName:lower() then
                            target = p
                            break
                        end
                    end
                else
                    target = client
                end

                if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                    currentFormasiTarget = target
                    local hrp = target.Character.HumanoidRootPart
                    local uid = tostring(localPlayer.UserId)
                    
                    -- Calculate formation positions
                    local posisiTarget = nil
                    
                    if formasiCmd == "formasi1" then
                        Options.TextboxFormasi1:SetValue(target.DisplayName)
                        if uid == "8802945328" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * jarakFormasi)
                        elseif uid == "8802949363" then
                            posisiTarget = hrp.Position + (hrp.CFrame.RightVector * jarakFormasi)
                        elseif uid == "8802939883" then
                            posisiTarget = hrp.Position + (hrp.CFrame.RightVector * -jarakFormasi)
                        elseif uid == "8802998147" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -jarakFormasi)
                        elseif uid == "8802991722" then
                            posisiTarget = hrp.Position + Vector3.new(0, 0, -jarakFormasi)
                        end
                    elseif formasiCmd == "formasi2" then
                        Options.TextboxFormasi2:SetValue(target.DisplayName)
                        local diagonalDist = jarakFormasi * 0.7071
                        if uid == "8802945328" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * diagonalDist) + (hrp.CFrame.RightVector * diagonalDist)
                        elseif uid == "8802949363" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * diagonalDist) + (hrp.CFrame.RightVector * -diagonalDist)
                        elseif uid == "8802939883" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -diagonalDist) + (hrp.CFrame.RightVector * diagonalDist)
                        elseif uid == "8802998147" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -diagonalDist) + (hrp.CFrame.RightVector * -diagonalDist)
                        elseif uid == "8802991722" then
                            posisiTarget = hrp.Position
                        end
                    elseif formasiCmd == "formasi3" then
                        Options.TextboxFormasi3:SetValue(target.DisplayName)
                        if uid == "8802945328" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * jarakFormasi) + (hrp.CFrame.RightVector * -jarakFormasi*1.5)
                        elseif uid == "8802949363" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * jarakFormasi) + (hrp.CFrame.RightVector * -jarakFormasi*0.5)
                        elseif uid == "8802939883" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * jarakFormasi) + (hrp.CFrame.RightVector * jarakFormasi*0.5)
                        elseif uid == "8802998147" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * jarakFormasi) + (hrp.CFrame.RightVector * jarakFormasi*1.5)
                        elseif uid == "8802991722" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * jarakFormasi*1.2)
                        end
                    elseif formasiCmd == "formasi4" then
                        Options.TextboxFormasi4:SetValue(target.DisplayName)
                        if uid == "8802945328" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -jarakFormasi*0.75) + (hrp.CFrame.RightVector * jarakFormasi*1.5)
                        elseif uid == "8802949363" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -jarakFormasi*0.75) + (hrp.CFrame.RightVector * jarakFormasi*0.75)
                        elseif uid == "8802939883" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -jarakFormasi*0.75)
                        elseif uid == "8802998147" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -jarakFormasi*0.75) + (hrp.CFrame.RightVector * -jarakFormasi*0.75)
                        elseif uid == "8802991722" then
                            posisiTarget = hrp.Position + (hrp.CFrame.LookVector * -jarakFormasi*0.75) + (hrp.CFrame.RightVector * -jarakFormasi*1.5)
                        end
                    end
                    
                    if posisiTarget then
                        myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, hrp.Position)
                        moveToPosition(posisiTarget)
                    end
                else
                    Library:Notify("‚ùå Target tidak valid", 3)
                end
            elseif msg == "!absen" then
                local uid = tostring(localPlayer.UserId)
                local urutanBot = {
                    ["8802945328"] = 1,
                    ["8802949363"] = 2,
                    ["8802939883"] = 3,
                    ["8802998147"] = 4,
                    ["8802991722"] = 5,
                }
                local giliran = urutanBot[uid]
                if not giliran then return end

                task.spawn(function()
                    task.wait((giliran - 1) * 2.5)
                    local posisiAwal = myRootPart.Position
                    local posisiAbsen = hrp.Position + hrp.CFrame.LookVector * 3 + Vector3.new(0, 0.1, 0)
                    myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, hrp.Position)
                    moveToPosition(posisiAbsen)
                    
                    -- Wait until arrived
                    repeat task.wait() until (myRootPart.Position - posisiAbsen).Magnitude < 3
                    
                    task.wait(1.5)
                    myRootPart.CFrame = CFrame.lookAt(posisiAbsen, posisiAwal)
                    moveToPosition(posisiAwal)
                end)
            end
        end)
    end

    -- Setup existing players
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name == adminName then
            player.Chatted:Connect(function(msg)
                handleAdminCommand(player, msg)
            end)
        end
        setupClient(player)
    end

    -- Handle new players
    Players.PlayerAdded:Connect(function(player)
        if player.Name == adminName then
            player.Chatted:Connect(function(msg)
                handleAdminCommand(player, msg)
            end)
        end
        setupClient(player)
    end)

    -- Character handling
    localPlayer.CharacterAdded:Connect(function()
        updateBotRefs()
        if toggleAktif then
            Library:Notify("‚úÖ Karakter baru di-load", 2)
        end
    end)

    -- Main movement loop
    loopTask = RunService.Heartbeat:Connect(function()
        -- Update path following
        if waypoints and currentWaypointIndex then
            updatePathFollowing()
        end
        
        -- Main follow logic
        if followAllowed and currentFormasiTarget and currentFormasiTarget.Character then
            local targetHRP = currentFormasiTarget.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local currentBotID = tostring(localPlayer.UserId)
                local settings = botSettings[currentBotID] or {followDistance = jarakIkut, minDistance = jarakMinimum}
                
                local followPos = targetHRP.Position - (targetHRP.CFrame.LookVector * settings.followDistance)
                local distance = (myRootPart.Position - followPos).Magnitude
                
                if distance > settings.minDistance then
                    myRootPart.CFrame = CFrame.lookAt(myRootPart.Position, targetHRP.Position)
                    moveToPosition(followPos)
                end
            end
        end
    end)
end

-- Initial setup
Library:Notify("‚úÖ Script loaded! Enable Bot Follow to start", 5)
