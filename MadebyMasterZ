-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

local Options = Library.Options

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Minimal Bot - FiestaGuardVip",
    Footer = "v1.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

-- ✅ Global Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

local clientName = "FiestaGuardVip"
local jarakIkut = 5
local jarakFormasi = 5
local jarakMinimum = 2
local toggleAktif = false
local followAllowed = false
local currentFormasiTarget = nil
local currentFormation = nil

local followConnection = nil
local loopTask = nil
local humanoid = nil
local myRootPart = nil
local client = nil

-- ✅ Debug function
local function debugPrint(msg)
    print("[DEBUG] "..msg)
end

-- ✅ Reset & Stop Function
local function runStopCommand()
    followAllowed = false
    currentFormasiTarget = nil
    currentFormation = nil
    if humanoid and myRootPart then
        humanoid:MoveTo(myRootPart.Position)
    end
    Options.TextboxDisplayName:SetValue("")
    Options.TextboxFormasi1:SetValue("")
    Options.TextboxFormasi2:SetValue("")
    debugPrint("Bot stopped")
end

-- ✅ Refresh Bot
local function fullRefresh()
    runStopCommand()
    task.wait(0.5)
    if followConnection then followConnection:Disconnect() end
    if loopTask then loopTask:Disconnect() end
    if toggleAktif then
        setupBotFollowSystem()
    end
    debugPrint("System refreshed")
end

-- ✅ Update Humanoid & RootPart
local function updateBotRefs()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    myRootPart = character:WaitForChild("HumanoidRootPart")
    debugPrint("Bot refs updated")
end

-- ✅ Calculate Formation Position
local function getFormationPosition(targetHRP, formationType)
    local uid = tostring(localPlayer.UserId)
    local formasi = {}
    if formationType == "formasi1" then
        formasi = {
            ["8802945328"] = targetHRP.Position + (targetHRP.CFrame.LookVector * jarakFormasi),
            ["8802949363"] = targetHRP.Position + (targetHRP.CFrame.RightVector * jarakFormasi),
            ["8802939883"] = targetHRP.Position + (targetHRP.CFrame.RightVector * -jarakFormasi),
            ["8802998147"] = targetHRP.Position + (targetHRP.CFrame.LookVector * -jarakFormasi),
            ["8802991722"] = targetHRP.Position + Vector3.new(0, 0, -jarakFormasi)
        }
    elseif formationType == "formasi2" then
        local diag = jarakFormasi * 0.7071
        formasi = {
            ["8802945328"] = targetHRP.Position + targetHRP.CFrame.LookVector*diag + targetHRP.CFrame.RightVector*diag,
            ["8802949363"] = targetHRP.Position + targetHRP.CFrame.LookVector*diag + targetHRP.CFrame.RightVector*-diag,
            ["8802939883"] = targetHRP.Position + targetHRP.CFrame.LookVector*-diag + targetHRP.CFrame.RightVector*diag,
            ["8802998147"] = targetHRP.Position + targetHRP.CFrame.LookVector*-diag + targetHRP.CFrame.RightVector*-diag,
            ["8802991722"] = targetHRP.Position
        }
    end
    return formasi[uid]
end

-- ✅ UI Setup
local GroupBox1 = Tabs.Main:AddLeftGroupbox("Main Options")
GroupBox1:AddToggle("AktifkanFollow", {
    Text = "Enable Bot Follow",
    Default = false,
    Callback = function(Value)
        toggleAktif = Value
        if Value then
            debugPrint("Toggle ON")
            setupBotFollowSystem()
        else
            debugPrint("Toggle OFF")
            runStopCommand()
            if loopTask then loopTask:Disconnect() end
            if followConnection then followConnection:Disconnect() end
        end
    end,
})

GroupBox1:AddInput("NamaClientInput", {
    Default = clientName,
    Text = "Client Name",
    Callback = function(Value)
        clientName = Value
        debugPrint("Client set to: "..clientName)
    end,
})

GroupBox1:AddInput("JarakIkutInput", {
    Default = "5",
    Text = "Follow Distance",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then jarakIkut = num debugPrint("jarakIkut set: "..num) end
    end,
})

GroupBox1:AddInput("JarakFormasiInput", {
    Default = "5",
    Text = "Formation Distance",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then jarakFormasi = num debugPrint("jarakFormasi set: "..num) end
    end,
})

-- ✅ Textboxes
local GroupBox2 = Tabs.Main:AddLeftGroupbox("Textbox")
GroupBox2:AddInput("TextboxDisplayName",{Default="","Text":"Target DisplayName"})
GroupBox2:AddInput("TextboxFormasi1",{Default="","Text":"Formation 1 Target"})
GroupBox2:AddInput("TextboxFormasi2",{Default="","Text":"Formation 2 Target"})

-- ✅ Follow System
function setupBotFollowSystem()
    updateBotRefs()

    local function setupClient(player)
        if player.Name ~= clientName then return end
        client = player
        debugPrint("Client detected: "..player.Name)

        followConnection = player.Chatted:Connect(function(msg)
            msg = msg:lower()
            debugPrint("Client chat: "..msg)
            local hrp = client.Character and client.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then debugPrint("Client HRP belum ada!") return end

            if msg=="!ikuti" then
                followAllowed=true
                currentFormasiTarget=client
                debugPrint("Bot siap mengikuti "..client.Name)
            elseif msg=="!stop" then
                runStopCommand()
            elseif msg=="!refresh" then
                fullRefresh()
            elseif msg:match("^!formasi[12]") then
                runStopCommand()
                local formasiCmd = msg:match("^!(formasi[12])")
                currentFormation=formasiCmd
                currentFormasiTarget=client
                debugPrint("Formation "..formasiCmd.." aktif")
                if formasiCmd=="formasi1" then Options.TextboxFormasi1:SetValue(client.DisplayName)
                elseif formasiCmd=="formasi2" then Options.TextboxFormasi2:SetValue(client.DisplayName) end
            end
        end)
    end

    for _,player in ipairs(Players:GetPlayers()) do setupClient(player) end
    Players.PlayerAdded:Connect(setupClient)
    localPlayer.CharacterAdded:Connect(updateBotRefs)

    loopTask = RunService.Heartbeat:Connect(function()
        if not toggleAktif then return end
        if not currentFormasiTarget then debugPrint("No target") return end
        if not currentFormasiTarget.Character then debugPrint("Target not spawned") return end
        if not humanoid or not myRootPart then debugPrint("Bot not ready") return end

        local targetHRP = currentFormasiTarget.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then debugPrint("Target HRP not found") return end

        if followAllowed then
            if currentFormation then
                local pos = getFormationPosition(targetHRP,currentFormation)
                if pos then
                    if (myRootPart.Position-pos).Magnitude>jarakMinimum then
                        myRootPart.CFrame=CFrame.lookAt(myRootPart.Position,targetHRP.Position)
                        humanoid:MoveTo(pos)
                        debugPrint("Bot bergerak ke formation: "..tostring(pos))
                    end
                end
            else
                local pos = targetHRP.Position - targetHRP.CFrame.LookVector*jarakIkut
                if (myRootPart.Position-pos).Magnitude>jarakMinimum then
                    myRootPart.CFrame=CFrame.lookAt(myRootPart.Position,targetHRP.Position)
                    humanoid:MoveTo(pos)
                    debugPrint("Bot bergerak ke: "..tostring(pos))
                else
                    debugPrint("Bot dekat target")
                end
            end
        end
    end)
end
